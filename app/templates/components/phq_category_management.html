<!-- app/templates/components/phq_category_management.html -->
<div class="space-y-6">
    <!-- Scale Configuration -->
    {% include 'components/phq_scale_settings.html' %}
    <!-- PHQ Categories Builder -->
    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100 p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
            </div>
            PHQ-9 Categories Builder
        </h3>
        <p class="text-gray-600 mb-6">Build your PHQ-9 assessment by adding categories and questions</p>
        
        <!-- Quick Actions -->
        <div class="mb-6 p-4 bg-white rounded-lg border border-green-200">
            <div class="flex flex-wrap gap-4">
                <button type="button" onclick="createAllDefaultCategories()" 
                        class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    Create All Default Categories
                </button>
                <button type="button" onclick="clearAllCategories()" 
                        class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                    Delete All Categories
                </button>
            </div>
            <p class="text-sm text-gray-500 mt-2">Quick actions to setup or reset your PHQ-9 categories</p>
        </div>

        <!-- Add New Category -->
        <div class="mb-6 p-4 bg-white rounded-lg border border-green-200">
            <h4 class="font-medium text-gray-900 mb-3">Add New Category</h4>
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-48">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Available PHQ-9 Categories</label>
                    <select id="available_categories" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="">Select a category to add...</option>
                        {% for category_type in phq_category_types %}
                            {% if category_type.number not in existing_category_numbers %}
                            <option value="{{ category_type.number }}" data-name="{{ category_type.name }}" data-description="{{ category_type.description }}" data-question="{{ category_type.default_question }}">
                                {{ category_type.number }}. {{ category_type.name }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <button type="button" onclick="addSelectedCategory()" 
                        class="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    Add Category
                </button>
            </div>
        </div>

        <!-- Current Categories -->
        <div class="space-y-4" id="categories_container">
            <h4 class="font-medium text-gray-900">Current Categories ({{ existing_categories|length }})</h4>
            
            {% if existing_categories %}
                {% for cat_num in existing_categories %}
                {% set category_type = phq_category_types|selectattr('number', 'equalto', cat_num)|first %}
                {% set questions = phq_categories.get(cat_num, {}).get('questions', [category_type.default_question]) %}
                
                <div class="bg-white rounded-lg border border-green-200 p-4" id="category_{{ cat_num }}">
                    <!-- Hidden field to track this category -->
                    <input type="hidden" name="phq_category_{{ cat_num }}_exists" value="1">
                    
                    <!-- Category Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">
                                {{ cat_num }}
                            </div>
                            <div>
                                <h5 class="font-medium text-gray-900">{{ category_type.name }}</h5>
                                <p class="text-sm text-gray-600">{{ category_type.description }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="button" onclick="resetCategory({{ cat_num }})" 
                                    class="text-blue-600 hover:text-blue-800 p-1" title="Reset to default">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                            <button type="button" onclick="deleteCategory({{ cat_num }})" 
                                    class="text-red-600 hover:text-red-800 p-1" title="Delete category">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Questions -->
                    <div class="space-y-3" id="category_{{ cat_num }}_questions">
                        <div class="flex items-center justify-between">
                            <label class="block text-sm font-medium text-gray-700">Questions for this category:</label>
                            <button type="button" onclick="clearCategoryQuestions({{ cat_num }})" 
                                    class="text-red-600 hover:text-red-800 text-xs">
                                Clear all questions
                            </button>
                        </div>
                        
                        {% for question in questions %}
                        <div class="flex items-center space-x-2 question-row">
                            <input type="text" 
                                   name="phq_category_{{ cat_num }}_question_{{ loop.index0 }}"
                                   value="{{ question }}"
                                   class="flex-1 p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                                   placeholder="Question {{ loop.index }}">
                            <button type="button" onclick="removeQuestion(this)" 
                                    class="text-red-600 hover:text-red-800 p-1" title="Remove question">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        {% endfor %}
                        
                        <!-- Add Question Button -->
                        <button type="button" onclick="addQuestion({{ cat_num }})" 
                                class="w-full flex items-center justify-center py-2 px-3 border border-dashed border-gray-300 rounded text-sm font-medium text-gray-600 hover:text-gray-900 hover:border-gray-400 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Add Question
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-8 text-gray-500 bg-white rounded-lg border border-gray-200">
                    <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <p class="text-lg font-medium">No PHQ-9 categories created yet</p>
                    <p class="text-sm">Add categories above or click "Create All Default Categories"</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Default category data from enum
const defaultCategories = {
    {% for category_type in phq_category_types %}
    {{ category_type.number }}: {
        name: "{{ category_type.name|e }}",
        description: "{{ category_type.description|e }}",
        question: "{{ category_type.default_question|e }}"
    },
    {% endfor %}
};

function addSelectedCategory() {
    const select = document.getElementById('available_categories');
    const selectedOption = select.options[select.selectedIndex];
    
    if (!selectedOption.value) {
        alert('Please select a category to add');
        return;
    }
    
    const catNum = parseInt(selectedOption.value);
    const catData = defaultCategories[catNum];
    
    // Create new category element
    const categoryHtml = `
        <div class="bg-white rounded-lg border border-green-200 p-4" id="category_${catNum}">
            <input type="hidden" name="phq_category_${catNum}_exists" value="1">
            
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">
                        ${catNum}
                    </div>
                    <div>
                        <h5 class="font-medium text-gray-900">${catData.name}</h5>
                        <p class="text-sm text-gray-600">${catData.description}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" onclick="resetCategory(${catNum})" 
                            class="text-blue-600 hover:text-blue-800 p-1" title="Reset to default">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                    <button type="button" onclick="deleteCategory(${catNum})" 
                            class="text-red-600 hover:text-red-800 p-1" title="Delete category">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="space-y-3" id="category_${catNum}_questions">
                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium text-gray-700">Questions for this category:</label>
                    <button type="button" onclick="clearCategoryQuestions(${catNum})" 
                            class="text-red-600 hover:text-red-800 text-xs">
                        Clear all questions
                    </button>
                </div>
                
                <div class="flex items-center space-x-2 question-row">
                    <input type="text" 
                           name="phq_category_${catNum}_question_0"
                           value="${catData.question}"
                           class="flex-1 p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
                           placeholder="Question 1">
                    <button type="button" onclick="removeQuestion(this)" 
                            class="text-red-600 hover:text-red-800 p-1" title="Remove question">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <button type="button" onclick="addQuestion(${catNum})" 
                        class="w-full flex items-center justify-center py-2 px-3 border border-dashed border-gray-300 rounded text-sm font-medium text-gray-600 hover:text-gray-900 hover:border-gray-400 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Question
                </button>
            </div>
        </div>
    `;
    
    // Add to container
    const container = document.getElementById('categories_container');
    const emptyState = container.querySelector('.text-center.py-8');
    if (emptyState) {
        emptyState.remove();
    }
    
    container.insertAdjacentHTML('beforeend', categoryHtml);
    
    // Remove from available options
    selectedOption.remove();
    select.selectedIndex = 0;
}

function createAllDefaultCategories() {
    if (!confirm('This will create all 9 PHQ-9 categories with default questions. Continue?')) return;
    
    const select = document.getElementById('available_categories');
    const options = Array.from(select.options).slice(1); // Skip first empty option
    
    options.forEach(option => {
        select.value = option.value;
        addSelectedCategory();
    });
}

function deleteCategory(catNum) {
    if (!confirm(`Delete category ${catNum} and all its questions?`)) return;
    
    const categoryElement = document.getElementById(`category_${catNum}`);
    categoryElement.remove();
    
    // Add back to available options
    const select = document.getElementById('available_categories');
    const catData = defaultCategories[catNum];
    const option = new Option(`${catNum}. ${catData.name}`, catNum);
    option.setAttribute('data-name', catData.name);
    option.setAttribute('data-description', catData.description);
    option.setAttribute('data-question', catData.question);
    select.appendChild(option);
    
    // Sort options by category number
    const optionsArray = Array.from(select.options).slice(1);
    optionsArray.sort((a, b) => parseInt(a.value) - parseInt(b.value));
    optionsArray.forEach(option => select.appendChild(option));
    
    // Check if no categories left
    const container = document.getElementById('categories_container');
    const categories = container.querySelectorAll('[id^="category_"]');
    if (categories.length === 0) {
        container.insertAdjacentHTML('beforeend', `
            <div class="text-center py-8 text-gray-500 bg-white rounded-lg border border-gray-200">
                <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                <p class="text-lg font-medium">No PHQ-9 categories created yet</p>
                <p class="text-sm">Add categories above or click "Create All Default Categories"</p>
            </div>
        `);
    }
}

function clearAllCategories() {
    if (!confirm('Delete ALL categories and questions? This cannot be undone.')) return;
    
    const categories = document.querySelectorAll('[id^="category_"]');
    categories.forEach(cat => {
        const catNum = parseInt(cat.id.split('_')[1]);
        deleteCategory(catNum);
    });
}

function resetCategory(catNum) {
    if (!confirm(`Reset category ${catNum} to default question?`)) return;
    
    const container = document.getElementById(`category_${catNum}_questions`);
    const questionRows = container.querySelectorAll('.question-row');
    
    // Remove all questions except first
    for (let i = 1; i < questionRows.length; i++) {
        questionRows[i].remove();
    }
    
    // Set first question to default
    const firstInput = container.querySelector('input[type="text"]');
    if (firstInput) {
        firstInput.value = defaultCategories[catNum].question;
    }
}

function clearCategoryQuestions(catNum) {
    if (!confirm(`Clear all questions in category ${catNum}?`)) return;
    
    const container = document.getElementById(`category_${catNum}_questions`);
    const questionRows = container.querySelectorAll('.question-row');
    questionRows.forEach(row => row.remove());
    
    // Add one empty question
    addQuestion(catNum);
}

function addQuestion(categoryNum) {
    const container = document.getElementById(`category_${categoryNum}_questions`);
    const questionRows = container.querySelectorAll('.question-row');
    const questionCount = questionRows.length;
    
    const newQuestionDiv = document.createElement('div');
    newQuestionDiv.className = 'flex items-center space-x-2 question-row';
    newQuestionDiv.innerHTML = `
        <input type="text" 
               name="phq_category_${categoryNum}_question_${questionCount}"
               class="flex-1 p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"
               placeholder="Question ${questionCount + 1}">
        <button type="button" onclick="removeQuestion(this)" 
                class="text-red-600 hover:text-red-800 p-1" title="Remove question">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    `;
    
    // Insert before the "Add Question" button
    const addButton = container.querySelector('button[onclick^="addQuestion"]');
    container.insertBefore(newQuestionDiv, addButton);
}

function removeQuestion(button) {
    const container = button.closest('[id$="_questions"]');
    const questionRows = container.querySelectorAll('.question-row');
    
    // Don't allow removing if only one question
    if (questionRows.length <= 1) {
        alert('Each category must have at least one question');
        return;
    }
    
    button.parentNode.remove();
    
    // Re-index remaining questions
    const catNum = container.id.split('_')[1];
    const questionInputs = container.querySelectorAll('input[type="text"]');
    questionInputs.forEach((input, index) => {
        input.name = `phq_category_${catNum}_question_${index}`;
        input.placeholder = `Question ${index + 1}`;
    });
}
</script>