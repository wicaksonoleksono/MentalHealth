<!-- app/templates/components/settings_tabs.html -->
<div class="bg-white rounded-t-2xl shadow-xl overflow-hidden" x-data="{ activeTab: '{{ active_tab or 'openquestion' }}' }" @switch-tab.window="activeTab = $event.detail">
    <div class="border-b border-gray-200">
        <nav class="flex space-x-8 px-6" aria-label="Tabs">
            <button @click="activeTab = 'openquestion'" 
                    :class="activeTab === 'openquestion' ? 'border-blue-500 text-blue-600 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm transition-all duration-200 rounded-t-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    AI Assistant
                </div>
            </button>
            
            <button @click="activeTab = 'consent'" 
                    :class="activeTab === 'consent' ? 'border-purple-500 text-purple-600 bg-purple-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm transition-all duration-200 rounded-t-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Consent Form
                </div>
            </button>
            
            <button @click="activeTab = 'phq9'" 
                    :class="activeTab === 'phq9' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm transition-all duration-200 rounded-t-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    PHQ-9 Settings
                </div>
            </button>
            
            <button @click="activeTab = 'image_capture'" 
                    :class="activeTab === 'image_capture' ? 'border-orange-500 text-orange-600 bg-orange-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                    class="whitespace-nowrap py-4 px-4 border-b-2 font-medium text-sm transition-all duration-200 rounded-t-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Image Capture
                </div>
            </button>
        </nav>
    </div>

    <!-- Main Settings Form -->
    <form method="POST" action="{{ url_for('settings.save_settings') }}" class="p-8">
        <input type="hidden" name="active_tab" :value="activeTab">
        
        <!-- AI Assistant Tab -->
        <div x-show="activeTab === 'openquestion'" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="space-y-6">
            {% include 'components/openquestion_tab.html' %}
        </div>

        <!-- Consent Form Tab -->
        <div x-show="activeTab === 'consent'" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="space-y-6">
            {% include 'components/consent_tab.html' %}
        </div>

        <!-- PHQ-9 Settings Tab (Combined) -->
        <div x-show="activeTab === 'phq9'" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="space-y-6">
            
            <!-- PHQ Scale Configuration -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-100 p-6" x-data="scaleConfig()">
                <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    PHQ-9 Configuration
                </h3>
                <p class="text-gray-600 mb-6">Configure response scale, behavior settings, and instructions</p>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Point Range Configuration -->
                        <div class="bg-white rounded-lg p-4 border border-purple-200">
                            <h4 class="font-medium text-gray-900 mb-3">Response Scale Range</h4>
                            <div class="flex items-center space-x-4 mb-4">
                                <div class="flex-1">
                                    <label class="block text-sm text-gray-600 mb-1">Min Value</label>
                                    <input type="number" 
                                           x-model="minValue"
                                           @input="updateRange()"
                                           name="scale_min" 
                                           min="0" max="5"
                                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm text-gray-600 mb-1">Max Value</label>
                                    <input type="number" 
                                           x-model="maxValue"
                                           @input="updateRange()"
                                           name="scale_max" 
                                           min="1" max="10"
                                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-3">
                                <p class="text-sm text-purple-800">
                                    <strong>Scale Range:</strong> <span x-text="minValue"></span> to <span x-text="maxValue"></span>
                                    (<span x-text="(maxValue - minValue + 1)"></span> response options)
                                </p>
                                <p class="text-xs text-purple-600 mt-1">Standard PHQ-9 uses 0-3 range (4 options)</p>
                            </div>
                        </div>

                        <!-- Response Labels (Dynamic) -->
                        <div class="bg-white rounded-lg p-4 border border-purple-200">
                            <h4 class="font-medium text-gray-900 mb-3">Response Labels</h4>
                            <div class="space-y-3 max-h-64 overflow-y-auto">
                                <template x-for="i in responseOptions" :key="i">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-purple-100 text-purple-800 rounded-full flex items-center justify-center text-sm font-bold" x-text="i"></div>
                                        <div class="flex-1">
                                            <input type="text" 
                                                   :name="'scale_label_' + i"
                                                   :value="getDefaultLabel(i)"
                                                   :placeholder="'Label for ' + i + ' points'"
                                                   class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Additional PHQ Settings -->
                    <div class="bg-white rounded-lg p-4 border border-purple-200">
                        <h4 class="font-medium text-gray-900 mb-3">Assessment Behavior</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Randomize Question Order</label>
                                    <p class="text-sm text-gray-500">Randomly shuffle questions within each category</p>
                                </div>
                                <input type="hidden" name="phq9_randomize_questions" value="0">
                                <input type="checkbox" name="phq9_randomize_questions" value="1" 
                                       {{ 'checked' if phq9_randomize_questions else '' }}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-medium text-gray-700">Show Progress Indicator</label>
                                    <p class="text-sm text-gray-500">Display progress bar during assessment</p>
                                </div>
                                <input type="hidden" name="phq9_show_progress" value="0">
                                <input type="checkbox" name="phq9_show_progress" value="1" 
                                       {{ 'checked' if phq9_show_progress else '' }}
                                       class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Questions Per Page</label>
                                <select name="phq9_questions_per_page" 
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="1" {{ 'selected' if phq9_questions_per_page == 1 else '' }}>1 question per page</option>
                                    <option value="3" {{ 'selected' if phq9_questions_per_page == 3 else '' }}>3 questions per page</option>
                                    <option value="5" {{ 'selected' if phq9_questions_per_page == 5 else '' }}>5 questions per page</option>
                                    <option value="0" {{ 'selected' if phq9_questions_per_page == 0 else '' }}>All questions on one page</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">PHQ-9 Instructions</label>
                                <textarea name="phq9_instructions" rows="4" 
                                          placeholder="Instructions shown to patients before PHQ-9 assessment..."
                                          class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">{{ phq9_instructions }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Scale Preview -->
                    <div class="bg-white rounded-lg p-4 border border-purple-200">
                        <h4 class="font-medium text-gray-900 mb-3">Scale Preview</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="i in responseOptions" :key="i">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 min-w-0 flex-1">
                                    <div class="text-center">
                                        <div class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center mx-auto mb-2 text-sm font-medium" 
                                             x-text="i"></div>
                                        <div class="text-xs text-gray-600 break-words" 
                                             x-text="getCurrentLabel(i)"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PHQ Question Management -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-100">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">PHQ-9 Question Management</h3>
                                <p class="text-gray-600 text-sm">Manage depression screening categories and their questions</p>
                            </div>
                        </div>
                    </div>

                    <!-- Categories Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for category_data in categories %}
                        {% set category = category_data.category %}
                        {% set questions = category_data.questions %}
                        
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                            <!-- Category Header -->
                            <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-4 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-3">
                                            <span class="text-sm font-bold">{{ category.category_number }}</span>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-semibold">{{ category.category_name }}</h4>
                                            <p class="text-green-100 text-xs">{{ category.description }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Questions List -->
                            <div class="p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="font-medium text-gray-900">Questions</h5>
                                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">
                                        {{ questions|length }}
                                    </span>
                                </div>

                                <div class="space-y-2 max-h-48 overflow-y-auto">
                                    {% for question in questions %}
                                    <div class="border border-gray-200 rounded-lg p-3 text-sm">
                                        <p class="text-gray-700 leading-relaxed">{{ question.question_text }}</p>
                                        <div class="flex items-center justify-between mt-2">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                                  {% if question.is_active %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {% if question.is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Capture Tab -->
        <div x-show="activeTab === 'image_capture'" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-4"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             class="space-y-6">
            {% include 'components/image_capture_tab.html' %}
        </div>

        <!-- Save Button -->
        <div class="flex justify-end pt-8 pb-8 pr-8 border-t border-gray-200 mt-8">
            <button type="submit" 
                    class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-xl font-medium hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transform transition-all duration-200 hover:scale-105 shadow-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Save Settings
                </div>
            </button>
        </div>
    </form>
</div>

<script>
function scaleConfig() {
    return {
        minValue: {{ scale_min or 0 }},
        maxValue: {{ scale_max or 3 }},
        responseOptions: [],
        scaleLabels: {{ scale_labels|tojson if scale_labels else '{}' }},
        defaultLabels: {
            0: 'Tidak pernah',
            1: 'Beberapa hari terakhir', 
            2: 'Lebih dari 1 minggu',
            3: 'Hampir setiap hari',
            4: 'Sangat sering',
            5: 'Selalu',
            6: 'Terus menerus',
            7: 'Ekstrem',
            8: 'Maksimal',
            9: 'Total',
            10: 'Absolute'
        },
        init() {
            this.updateRange();
        },
        updateRange() {
            if (this.minValue > this.maxValue) {
                this.maxValue = this.minValue;
            }
            
            this.responseOptions = [];
            for (let i = this.minValue; i <= this.maxValue; i++) {
                this.responseOptions.push(i);
            }
        },

        getDefaultLabel(value) {
            return this.scaleLabels[value.toString()] || this.defaultLabels[value] || `Option ${value}`;
        },

        getCurrentLabel(value) {
            const input = document.querySelector(`[name="scale_label_${value}"]`);
            return input?.value || this.getDefaultLabel(value);
        }
    };
}
</script>