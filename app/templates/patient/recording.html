{% macro recording_controls(recording_config, assessment_type, session_id, question_identifier) %}
<div x-data="mediaRecorder('{{ recording_config.mode }}', '{{ assessment_type }}', '{{ session_id }}', '{{ question_identifier }}', {{ recording_config|tojson }})" class="media-recorder-container">
    <video x-ref="videoElement" autoplay muted playsinline class="w-full h-auto bg-gray-900 rounded-lg shadow-lg"></video>
    
    <div x-show="mode === 'video'" class="controls mt-4 flex justify-center items-center space-x-4">
        <button @click="startRecording()" x-show="!isRecording && !isPaused" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            Mulai Merekam
        </button>
        <button @click="pauseRecording()" x-show="isRecording" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
            Jeda
        </button>
        <button @click="resumeRecording()" x-show="isPaused" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            Lanjutkan
        </button>
        <button @click="stopRecording()" x-show="isRecording || isPaused" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
            Berhenti Merekam
        </button>
    </div>

    <div x-show="isRecording" class="recording-indicator mt-2 text-center text-red-500 font-bold">
        <span class="animate-pulse">Merekam...</span>
        <span x-text="elapsedTime"></span>
    </div>

    <div x-show="lastVideoUrl" class="mt-4">
        <h4 class="text-lg font-semibold">Rekaman Terakhir:</h4>
        <video :src="lastVideoUrl" controls class="w-full h-auto"></video>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('mediaRecorder', (mode, assessmentType, sessionId, questionIdentifier, config) => ({
        mode: mode,
        assessmentType: assessmentType,
        sessionId: sessionId,
        questionIdentifier: questionIdentifier,
        config: config,
        isRecording: false,
        isPaused: false,
        mediaStream: null,
        mediaRecorder: null,
        recordedChunks: [],
        lastVideoUrl: null,
        timer: null,
        elapsedTime: '00:00',
        captureInterval: null,

        init() {
            console.log('mediaRecorder init dipanggil');
            this.setupMedia();
            if (this.mode === 'video') {
                if (this.assessmentType === 'open_questions') {
                    console.log('Memulai perekaman video untuk pertanyaan terbuka');
                    this.startRecording();
                } else if (this.assessmentType === 'phq9') {
                    console.log('Memulai perekaman video untuk PHQ9');
                    this.startRecording();
                    document.getElementById('phq-form').addEventListener('submit', () => {
                        console.log('Formulir PHQ dikirim, menghentikan perekaman');
                        this.stopRecording();
                    });
                }
            } else if (this.mode === 'capture') {
                console.log('Memulai pengambilan gambar');
                this.startImageCapture();
            }
        },

        async setupMedia() {
            console.log('setupMedia dipanggil');
            try {
                this.mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: this.mode === 'video'
                });
                this.$refs.videoElement.srcObject = this.mediaStream;
                console.log('Aliran media berhasil diperoleh');
            } catch (err) {
                console.error('Error mengakses perangkat media.', err);
                alert('Tidak dapat mengakses kamera dan mikrofon. Harap pastikan izin diberikan.');
            }
        },

        startRecording() {
            console.log('startRecording dipanggil');
            if (!this.mediaStream) {
                console.error('Tidak ada aliran media yang tersedia untuk memulai perekaman.');
                return;
            }
            this.isRecording = true;
            this.isPaused = false;
            this.recordedChunks = [];
            
            const options = { mimeType: `video/${this.config.video_format};codecs=vp9` };
            console.log('Opsi MediaRecorder:', options);
            this.mediaRecorder = new MediaRecorder(this.mediaStream, options);

            this.mediaRecorder.ondataavailable = (event) => {
                console.log('peristiwa ondataavailable', event.data.size);
                if (event.data.size > 0) {
                    this.recordedChunks.push(event.data);
                }
            };

            this.mediaRecorder.onstop = () => {
                console.log('peristiwa onstop');
                const blob = new Blob(this.recordedChunks, { type: `video/${this.config.video_format}` });
                this.lastVideoUrl = URL.createObjectURL(blob);
                console.log('Mengirim video ke server');
                this.sendToServer(blob, 'video');
                this.isRecording = false;
                this.isPaused = false;
                clearInterval(this.timer);
                this.elapsedTime = '00:00';
            };

            this.mediaRecorder.start();
            this.startTimer();
            console.log('MediaRecorder dimulai');
        },

        stopRecording() {
            console.log('stopRecording dipanggil');
            if (this.mediaRecorder) {
                this.mediaRecorder.stop();
            }
            if (this.captureInterval) {
                clearInterval(this.captureInterval);
            }
        },

        pauseRecording() {
            console.log('pauseRecording dipanggil');
            if (this.mediaRecorder && this.isRecording) {
                this.mediaRecorder.pause();
                this.isPaused = true;
                this.isRecording = false;
                clearInterval(this.timer);
            }
        },

        resumeRecording() {
            console.log('resumeRecording dipanggil');
            if (this.mediaRecorder && this.isPaused) {
                this.mediaRecorder.resume();
                this.isPaused = false;
                this.isRecording = true;
                this.startTimer();
            }
        },

        startTimer() {
            console.log('startTimer dipanggil');
            let seconds = 0;
            this.timer = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                this.elapsedTime = `${mins}:${secs}`;
            }, 1000);
        },

        startImageCapture() {
            console.log('startImageCapture dipanggil');
            this.captureInterval = setInterval(() => {
                this.captureImage();
            }, this.config.capture_interval * 1000);
        },

        captureImage() {
            console.log('captureImage dipanggil');
            if (!this.mediaStream) {
                console.error('Tidak ada aliran media yang tersedia untuk pengambilan gambar.');
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = this.$refs.videoElement.videoWidth;
            canvas.height = this.$refs.videoElement.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(this.$refs.videoElement, 0, 0, canvas.width, canvas.height);

            canvas.toBlob((blob) => {
                console.log('Mengirim gambar ke server');
                this.sendToServer(blob, 'image');
            }, 'image/jpeg', this.config.image_quality);
        },

        sendToServer(blob, mediaType) {
            console.log(`sendToServer dipanggil untuk ${mediaType}`);
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                const base64data = reader.result;
                fetch('/capture-emotion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        assessment_type: this.assessmentType,
                        question_identifier: this.questionIdentifier,
                        media_type: mediaType,
                        file_data: base64data,
                        filename: `recording-${this.assessmentType}-${this.questionIdentifier}.${mediaType === 'video' ? this.config.video_format : 'jpeg'}`,
                        resolution: `${this.config.resolution}`,
                        quality: mediaType === 'video' ? this.config.video_quality : this.config.image_quality,
                        duration_ms: mediaType === 'video' ? this.getDuration() : null,
                        capture_timestamp: new Date().toISOString(),
                        recording_settings: this.config
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(`${mediaType} berhasil diunggah:`, data);
                    } else {
                        console.error(`Error mengunggah ${mediaType}:`, data.message);
                    }
                })
                .catch(error => {
                    console.error(`Error mengirim ${mediaType} ke server:`, error);
                });
            };
        },

        getDuration() {
            // This is an approximation. For more accuracy, you might need to inspect the blob.
            if (this.recordedChunks.length === 0) return 0;
            const first = this.recordedChunks[0].timeStamp;
            const last = this.recordedChunks[this.recordedChunks.length - 1].timeStamp;
            return last - first;
        }
    }));
});
</script>
{% endmacro %}